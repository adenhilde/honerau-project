#include "gatt.h"
#include <dbus/dbus.h>
#include <dbus/dbus-glib-lowlevel.h>
#include <stdio.h>
#include <string.h>

static DBusConnection *conn;

/* UUIDs */
#define SERVICE_UUID "12345678-1234-5678-1234-56789abcdef0"
#define CHAR_UUID    "12345678-1234-5678-1234-56789abcdef1"

/* Object paths */
#define SERVICE_PATH "/uri/gatt/service0"
#define CHAR_PATH    "/uri/gatt/service0/char0"

static DBusHandlerResult service_handler(DBusConnection *connection,
                                         DBusMessage *message,
                                         void *user_data)
{
    if (dbus_message_is_method_call(message,
        "org.freedesktop.DBus.Properties", "GetAll")) {

        const char *iface;
        DBusMessage *reply;
        DBusMessageIter iter, dict, entry, variant;

        dbus_message_get_args(message, NULL,
            DBUS_TYPE_STRING, &iface,
            DBUS_TYPE_INVALID);

        if (strcmp(iface, "org.bluez.GattService1") != 0)
            return DBUS_HANDLER_RESULT_NOT_YET_HANDLED;

        reply = dbus_message_new_method_return(message);
        dbus_message_iter_init_append(reply, &iter);
        dbus_message_iter_open_container(&iter,
            DBUS_TYPE_ARRAY, "{sv}", &dict);

        /* UUID */
        const char *uuid = SERVICE_UUID;
        dbus_message_iter_open_container(&dict,
            DBUS_TYPE_DICT_ENTRY, NULL, &entry);
        dbus_message_iter_append_basic(&entry,
            DBUS_TYPE_STRING, &(const char *){"UUID"});
        dbus_message_iter_open_container(&entry,
            DBUS_TYPE_VARIANT, "s", &variant);
        dbus_message_iter_append_basic(&variant,
            DBUS_TYPE_STRING, &uuid);
        dbus_message_iter_close_container(&entry, &variant);
        dbus_message_iter_close_container(&dict, &entry);

        /* Primary = true */
        dbus_bool_t primary = 1;
        dbus_message_iter_open_container(&dict,
            DBUS_TYPE_DICT_ENTRY, NULL, &entry);
        dbus_message_iter_append_basic(&entry,
            DBUS_TYPE_STRING, &(const char *){"Primary"});
        dbus_message_iter_open_container(&entry,
            DBUS_TYPE_VARIANT, "b", &variant);
        dbus_message_iter_append_basic(&variant,
            DBUS_TYPE_BOOLEAN, &primary);
        dbus_message_iter_close_container(&entry, &variant);
        dbus_message_iter_close_container(&dict, &entry);

        dbus_message_iter_close_container(&iter, &dict);
        dbus_connection_send(connection, reply, NULL);
        dbus_message_unref(reply);

        return DBUS_HANDLER_RESULT_HANDLED;
    }

    return DBUS_HANDLER_RESULT_NOT_YET_HANDLED;
}


/* -------- Characteristic handler -------- */

static DBusHandlerResult char_handler(DBusConnection *connection,
                                      DBusMessage *message,
                                      void *user_data)
{
    if (dbus_message_is_method_call(message,
        "org.bluez.GattCharacteristic1", "ReadValue")) {

        DBusMessage *reply = dbus_message_new_method_return(message);
        DBusMessageIter iter, array;

        const char *value = "URI BLE OK";

        dbus_message_iter_init_append(reply, &iter);
        dbus_message_iter_open_container(&iter,
            DBUS_TYPE_ARRAY, "y", &array);

        for (size_t i = 0; i < strlen(value); i++) {
            dbus_message_iter_append_basic(
                &array, DBUS_TYPE_BYTE, &value[i]);
        }

        dbus_message_iter_close_container(&iter, &array);

        dbus_connection_send(connection, reply, NULL);
        dbus_message_unref(reply);

        return DBUS_HANDLER_RESULT_HANDLED;
    }

    return DBUS_HANDLER_RESULT_NOT_YET_HANDLED;
}

/* -------- GATT registration -------- */

bool gatt_init(void)
{
    DBusError err;
    dbus_error_init(&err);

    conn = dbus_bus_get(DBUS_BUS_SYSTEM, &err);
    if (!conn) {
        fprintf(stderr, "GATT: failed to get system bus\n");
        return false;
    }

    dbus_connection_setup_with_g_main(conn, NULL);

    /* Register characteristic object */
    static DBusObjectPathVTable char_vtable = {
        .message_function = char_handler
    };

    if (!dbus_connection_register_object_path(
            conn, CHAR_PATH, &char_vtable, NULL)) {
        fprintf(stderr, "GATT: failed to register characteristic\n");
        return false;
    }

    /* Register service + characteristic with BlueZ */
    DBusMessage *msg = dbus_message_new_method_call(
        "org.bluez",
        "/org/bluez/hci0",
        "org.bluez.GattManager1",
        "RegisterApplication");

    const char *app_path = "/uri/gatt";
    DBusMessageIter args, dict;

    dbus_message_iter_init_append(msg, &args);
    dbus_message_iter_append_basic(&args,
        DBUS_TYPE_OBJECT_PATH, &app_path);

    dbus_message_iter_open_container(&args,
        DBUS_TYPE_ARRAY, "{sv}", &dict);
    dbus_message_iter_close_container(&args, &dict);

    dbus_connection_send(conn, msg, NULL);
    dbus_message_unref(msg);

    printf("GATT service registered\n");
    return true;
}

